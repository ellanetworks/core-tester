/**
 * SPDX-License-Identifier: Apache-2.0
 * © Copyright 2023 Hewlett Packard Enterprise Development LP
 * © Copyright 2024 Valentin D'Emmanuele
 */
package build

import (
	"fmt"
	"net/netip"

	"github.com/free5gc/ngap/ngapType"
)

type PDUSessionResourceSetupResponseBuilder struct {
	pdu ngapType.NGAPPDU
	ies *ngapType.ProtocolIEContainerPDUSessionResourceSetupResponseIEs
}

type PDUSessionResourceSetupResponseOpts struct {
	AMFUENGAPID int64
	RANUENGAPID int64
	N3GnbIp     netip.Addr
	PDUSessions [16]*GnbPDUSession
}

func PDUSessionResourceSetupResponse(opts *PDUSessionResourceSetupResponseOpts) (ngapType.NGAPPDU, error) {
	return NewPDUSessionResourceSetupResponseBuilder().
		SetAmfUeNgapId(opts.AMFUENGAPID).SetRanUeNgapId(opts.RANUENGAPID).
		SetPDUSessionResourceSetupListSURes(opts.N3GnbIp, opts.PDUSessions).
		Build()
}

func NewPDUSessionResourceSetupResponseBuilder() *PDUSessionResourceSetupResponseBuilder {
	pdu := ngapType.NGAPPDU{}

	pdu.Present = ngapType.NGAPPDUPresentSuccessfulOutcome
	pdu.SuccessfulOutcome = new(ngapType.SuccessfulOutcome)

	successfulOutcome := pdu.SuccessfulOutcome
	successfulOutcome.ProcedureCode.Value = ngapType.ProcedureCodePDUSessionResourceSetup
	successfulOutcome.Criticality.Value = ngapType.CriticalityPresentReject

	successfulOutcome.Value.Present = ngapType.SuccessfulOutcomePresentPDUSessionResourceSetupResponse
	successfulOutcome.Value.PDUSessionResourceSetupResponse = new(ngapType.PDUSessionResourceSetupResponse)

	pDUSessionResourceSetupResponse := successfulOutcome.Value.PDUSessionResourceSetupResponse
	ies := &pDUSessionResourceSetupResponse.ProtocolIEs

	return &PDUSessionResourceSetupResponseBuilder{pdu, ies}
}

func (builder *PDUSessionResourceSetupResponseBuilder) SetAmfUeNgapId(amfUeNgapID int64) *PDUSessionResourceSetupResponseBuilder {
	// AMF UE NGAP ID
	ie := ngapType.PDUSessionResourceSetupResponseIEs{}
	ie.Id.Value = ngapType.ProtocolIEIDAMFUENGAPID
	ie.Criticality.Value = ngapType.CriticalityPresentIgnore
	ie.Value.Present = ngapType.PDUSessionResourceSetupResponseIEsPresentAMFUENGAPID
	ie.Value.AMFUENGAPID = new(ngapType.AMFUENGAPID)

	aMFUENGAPID := ie.Value.AMFUENGAPID
	aMFUENGAPID.Value = amfUeNgapID

	builder.ies.List = append(builder.ies.List, ie)

	return builder
}

func (builder *PDUSessionResourceSetupResponseBuilder) SetRanUeNgapId(ranUeNgapID int64) *PDUSessionResourceSetupResponseBuilder {
	// RAN UE NGAP ID
	ie := ngapType.PDUSessionResourceSetupResponseIEs{}
	ie.Id.Value = ngapType.ProtocolIEIDRANUENGAPID
	ie.Criticality.Value = ngapType.CriticalityPresentIgnore
	ie.Value.Present = ngapType.PDUSessionResourceSetupResponseIEsPresentRANUENGAPID
	ie.Value.RANUENGAPID = new(ngapType.RANUENGAPID)

	rANUENGAPID := ie.Value.RANUENGAPID
	rANUENGAPID.Value = ranUeNgapID

	builder.ies.List = append(builder.ies.List, ie)

	return builder
}

func (builder *PDUSessionResourceSetupResponseBuilder) SetPDUSessionResourceSetupListSURes(gnbN3IP netip.Addr, pduSessions [16]*GnbPDUSession) *PDUSessionResourceSetupResponseBuilder {
	// PDU Session Resource Setup Response List
	ie := ngapType.PDUSessionResourceSetupResponseIEs{}
	ie.Id.Value = ngapType.ProtocolIEIDPDUSessionResourceSetupListSURes
	ie.Criticality.Value = ngapType.CriticalityPresentIgnore
	ie.Value.Present = ngapType.PDUSessionResourceSetupResponseIEsPresentPDUSessionResourceSetupListSURes
	ie.Value.PDUSessionResourceSetupListSURes = new(ngapType.PDUSessionResourceSetupListSURes)

	pDUSessionResourceSetupListSURes := ie.Value.PDUSessionResourceSetupListSURes

	for _, pduSession := range pduSessions {
		if pduSession == nil {
			continue
		}

		// PDU Session Resource Setup Response Item in PDU Session Resource Setup Response List
		pDUSessionResourceSetupItemSURes := ngapType.PDUSessionResourceSetupItemSURes{}

		// PDU Session ID : This is an unique identifier generated by UE. Can’t be same as any existing PDU session.
		pDUSessionResourceSetupItemSURes.PDUSessionID.Value = pduSession.GetPduSessionId()

		respTransf, err := GetPDUSessionResourceSetupResponseTransfer(gnbN3IP, pduSession.GetTeidDownlink(), pduSession.GetQosId())
		if err != nil {
			fmt.Printf("failed to get PDUSessionResourceSetupResponseTransfer: %v\n", err)
			continue
		}

		pDUSessionResourceSetupItemSURes.PDUSessionResourceSetupResponseTransfer = respTransf

		pDUSessionResourceSetupListSURes.List = append(pDUSessionResourceSetupListSURes.List, pDUSessionResourceSetupItemSURes)
	}

	builder.ies.List = append(builder.ies.List, ie)

	return builder
}

func (builder *PDUSessionResourceSetupResponseBuilder) Build() (ngapType.NGAPPDU, error) {
	return builder.pdu, nil
}
